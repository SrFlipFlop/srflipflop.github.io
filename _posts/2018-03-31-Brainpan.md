---
layout: post
title: "Brainpan"
date: 2018-03-31 
description: "Writeup of Brainpan Virtual Machine"
tag: CTF
---   

TODO: intro

### Information gathering

To enumerate the attack surface we use, as allways, **nmap**. This machine only have two open services: a login pannel and web application.

![](/images/posts/Stapler/img1.png "Services discovered")

![](/images/posts/Stapler/img2.png "Trying to connect on the network service ")

![](/images/posts/Stapler/img3.png "Web service")

The web application only contains an image, so it's time to search some resource using **dirb**. The *bin* directory contains a *PE* file that seams to be the next step of the challange.

![](/images/posts/Stapler/img4.png "dirb execution")

![](/images/posts/Stapler/img5.png "Portable executable file")

### Reversing the PE file 

The strings indicates that the executable is the same service at the *9999* port. The first attempt that we will try is to search the password in the PE file or the algorithm that generates it (~~spoiler: the password is in the strings~~).

![](/images/posts/Stapler/img6.png "Strings in the executable file")

The aproach to search the password is to find the function that will compare with the user input. With **radare2** we can search for the functions used like *strcmp* that probably will be used to compare the user input with the password.
With *axt* we can see where is used the *strcmp* function and analyzing the function we found that *sheetstorm* is the input for the compare.

![](/images/posts/Stapler/img7.png "Searching the password")

Using the correct password the service prints the OK message but nothing more. The second path will consist in exploit the network service. 

![](/images/posts/Stapler/img8.png "Using the correct password")

### Exploting the service

> Note: to debug the executable I will use Immunity debugger in a Windows XP.

The first step to exploit a program consists in find if the service is vulnerable to a buffer overflow. In this case we will use the tipical *A* long string.

![](/images/posts/Stapler/img9.png "overflow the service")

Now to search the exact offset to overflow the buffer, we use **pattern\_create** to create a special long string. With the **pattern\_offset** now we can search for the value in the EIP register to know the correct offset. Finally with **python** we generate the string to put *B* in the EIP to confirm the offset.

![](/images/posts/Stapler/img10.png "Searching the offset")

![](/images/posts/Stapler/img11.png "Try the correct offset")

Now that we control the EIP, ...

![](/images/posts/Stapler/img12.png "")

![](/images/posts/Stapler/img13.png "")

![](/images/posts/Stapler/img14.png "")

![](/images/posts/Stapler/img15.png "")

![](/images/posts/Stapler/img16.png "")

![](/images/posts/Stapler/img17.png "")

![](/images/posts/Stapler/img18.png "")

![](/images/posts/Stapler/img19.png "")

![](/images/posts/Stapler/img20.png "")



